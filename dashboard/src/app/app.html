@if (backgroundImageUrl.isLoading()) {
  <div class="background-image-progress-bar-container">
    <mat-progress-bar
      mode="indeterminate"
      aria-label="Fetching new background image"
    ></mat-progress-bar>
  </div>
}
<div
  [style.background-image]="'url(' + backgroundImageUrlOrPrevious() + ')'"
  class="dashboard-root"
  tabindex="0"
  (click)="reloadPhoto()"
  (keyup.enter)="reloadPhoto()"
  (keydown.enter)="reloadPhoto()"
>
  <div class="data-container">
    <p class="display-large">{{ currentDate() | date: 'shortTime' }}</p>
    <p class="display-small">{{ currentDate() | date: 'fullDate' }}</p>
  </div>
  <div class="data-container">
    @if (currentWeather.hasValue()) {
      @let weather = currentWeather.value().weather[0];
      <div class="weather-icon-and-temp">
        <img
          class="weather-icon"
          [src]="'http://openweathermap.org/img/wn/' + weather.icon + '@2x.png'"
          [alt]="weather.description"
        />
        <span class="display-large"
          >{{ currentWeather.value().main.temp | number: '1.0-0' }}Â°F</span
        >
      </div>
      <div class="weather-details">
        <table class="weather-details-table">
          <tr>
            <th class="display-small" scope="row">Humidity:</th>
            <td class="display-small">
              {{ currentWeather.value().main.humidity | number: '1.0-0' }}%
            </td>
          </tr>
          <tr>
            <th class="display-small" scope="row">Wind Speed:</th>
            <td class="display-small">
              {{ currentWeather.value().wind.speed | number: '1.0-0' }} mph
            </td>
          </tr>
        </table>
      </div>
    } @else {
      <mat-progress-spinner
        mode="indeterminate"
        aria-label="Loading weather data..."
      ></mat-progress-spinner>
    }
  </div>
  <ng-template #busSchedule let-departuresResponse>
    @let currentTime = departuresResponse.currentTime;
    @let departures = departuresResponse.data.entry.arrivalsAndDepartures.slice(0, 5);
    @for (departure of departures; track departure.tripId + $index) {
      @let scheduledArrivalTime = departure.scheduledArrivalTime;
      @let predictedArrivalTime = departure.predictedArrivalTime;
      @let tripHeadsign = departure.tripHeadsign;
      @let routeShortName = departure.routeShortName;
      <div class="bus-departure mat-font-display-md">
        <div class="route-short-name">{{ routeShortName }}</div>
        <div class="trip-headsign">{{ tripHeadsign }}</div>
        <div class="arrival-time">
          @if (predictedArrivalTime > 0) {
            @let minutesUntilArrival = minutesUntil(predictedArrivalTime, currentTime);
            <span><mat-icon inline>android_wifi_3_bar</mat-icon>{{ minutesUntilArrival }}min</span>
          } @else {
            @let minutesUntilArrival = minutesUntil(scheduledArrivalTime, currentTime);
            <span>{{ minutesUntilArrival }}min</span>
          }
        </div>
      </div>
    }
    <div class="mat-font-title-sm mat-text-on-surface-variant last-updated-time">
      Updates approx every 60 seconds
    </div>
  </ng-template>
  <div class="data-container">
    <div class="mat-font-display-lg bus-direction">
      <mat-icon class="bus-icon">departure_board</mat-icon>&nbsp;Southbound
    </div>
    @if (southboundNextDepartures.hasValue()) {
      <ng-container
        *ngTemplateOutlet="
          busSchedule;
          context: {
            $implicit: southboundNextDepartures.value(),
          }
        "
      ></ng-container>
    }
    @if (southboundNextDepartures.isLoading()) {
      <div class="bus-schedule-progress-bar-container">
        <mat-progress-bar
          mode="indeterminate"
          aria-label="Fetching new bus schedule"
          class="bus-schedule-progress-bar"
        ></mat-progress-bar>
      </div>
    }
  </div>
  <div class="data-container">
    <div class="mat-font-display-lg bus-direction">
      <mat-icon class="bus-icon">departure_board</mat-icon>&nbsp;Northbound
    </div>
    @if (northboundNextDepartures.hasValue()) {
      <ng-container
        *ngTemplateOutlet="
          busSchedule;
          context: {
            $implicit: northboundNextDepartures.value(),
          }
        "
      ></ng-container>
    }
    @if (southboundNextDepartures.isLoading()) {
      <div class="bus-schedule-progress-bar-container">
        <mat-progress-bar
          mode="indeterminate"
          aria-label="Fetching new bus schedule"
          class="bus-schedule-progress-bar"
        ></mat-progress-bar>
      </div>
    }
  </div>
  <div class="data-container">
    @if (currentAirQuality.hasValue()) {
      <div class="air-quality">
        <p class="display-large">
          {{ aqiCategoryIcon() }} {{ aqi() }} <span>({{ aqiParameter() }})</span>
        </p>
        <p class="display-small">{{ aqiCategory() }}</p>
      </div>
    } @else {
      <mat-progress-spinner
        mode="indeterminate"
        aria-label="Loading air quality data..."
      ></mat-progress-spinner>
    }
  </div>
  <div class="data-container photo-metadata">
    @let metadata = backgroundImageMetdata();
    @if (metadata) {
      @if (metadata.location) {
        <span class="display-small photo-metadata-icon"
          ><mat-icon class="bigger-icon">location_on</mat-icon></span
        >
        <p class="display-small photo-metadata-text">
          {{ metadata.location }}
        </p>
      }
      <img
        class="photographer-avatar photo-metadata-icon"
        [src]="metadata.authorProfileImageUrl"
        alt=""
        role="presentation"
      />
      <p class="headline-large photo-metadata-text">
        {{ metadata.authorName }}
      </p>
      @if (metadata.exif) {
        <span class="display-small photo-metadata-icon"
          ><mat-icon class="bigger-icon">camera</mat-icon></span
        >
        <p class="headline-medium photo-metadata-text">
          {{ metadata.exif }}
        </p>
      }
    } @else {
      <mat-progress-spinner
        mode="indeterminate"
        aria-label="Loading background image metadata..."
      ></mat-progress-spinner>
    }
  </div>
</div>
